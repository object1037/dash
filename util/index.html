<!DOCTYPE html>
<html lang="en">

<body>
  <canvas>
  </canvas>
  <script src="./fonts.js"></script>
  <script>
    const COLS = 128;
    const ROWS = 296;
    const COLS_BYTES = COLS / 8;
    const FONT_W = 3;
    const FONT_H = 14;
    const FONT_SMALL_W = 2;
    const FONT_SMALL_H = 7;
    const FONT_DOT = 10;
    const FONT_HYPHEN = 11;
    const cellSize = 3;
    const borderSize = 0.5;
    const devicePixelRatio = window.devicePixelRatio || 1;

    const buf = new Uint8Array(COLS * ROWS / 8);

    const canvas = document.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    const width = COLS * (cellSize + borderSize) + borderSize;
    const height = ROWS * (cellSize + borderSize) + borderSize;
    canvas.width = width * devicePixelRatio;
    canvas.height = height * devicePixelRatio;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.scale(devicePixelRatio, devicePixelRatio);

    let rotated = false;
    canvas.addEventListener('click', () => {
      rotated = !rotated;
      if (rotated) {
        canvas.style.transform = 'rotate(0deg)';
        return;
      }
      canvas.style.transform = 'rotate(90deg)';
    })

    const toIdx = (x, y) => {
      return y * COLS_BYTES + x;
    }

    const drawFont = (start_x, start_y, isSmall, idx, buf) => {
      let font_w = FONT_W;
      let font_h = FONT_H;
      let fonts_buf = fonts;
      if (isSmall) {
        font_w = FONT_SMALL_W;
        font_h = FONT_SMALL_H;
        fonts_buf = fonts_small;
      }
      for (let offset_x = 0; offset_x < font_w; offset_x++) {
        for (let offset_y = 0; offset_y < font_h; offset_y++) {
          buf[toIdx(start_x + offset_x, start_y + offset_y)] |= fonts_buf[idx][offset_y * font_w + offset_x];
        }
      }
    }
    const drawNum = (start_x, start_y, isSmall, num, buf) => {
      let font_h = FONT_H - 2;
      let dot_offset_h = 0;
      if (isSmall) {
        font_h = FONT_SMALL_H - 1;
        dot_offset_h = -1;
      }
      if (num < 100) {
        // XY.Z
        drawFont(start_x, start_y, isSmall, Math.floor(num * 10) % 10, buf); // Z
        start_y += dot_offset_h;
        drawFont(start_x, start_y + font_h, isSmall, FONT_DOT, buf); // dot
        start_y += dot_offset_h;
        drawFont(start_x, start_y + font_h * 2, isSmall, Math.floor(num) % 10, buf);
        drawFont(start_x, start_y + font_h * 3, isSmall, Math.floor(num / 10), buf);
      } else {
        // WXYZ
        drawFont(start_x, start_y, isSmall, Math.floor(num) % 10, buf); // Z
        drawFont(start_x, start_y + font_h, isSmall, Math.floor(num / 10) % 10, buf); // Y
        drawFont(start_x, start_y + font_h * 2, isSmall, Math.floor(num / 100) % 10, buf); // X
        if (num >= 1000) {
          drawFont(start_x, start_y + font_h * 3, isSmall, Math.floor(num / 1000), buf); // W
        }
      }
    }

    const draw = () => {
      ctx.fillStyle = '#f5f5f5';
      ctx.fillRect(0, 0, width, height);
      for (let i = 0; i < COLS * ROWS; i++) {
        const byte = buf[Math.floor(i / 8)];
        const bit = 7 - (i & 7);
        ctx.fillStyle = '#fff';
        if ((byte >> bit) & 1) {
          ctx.fillStyle = '#000';
        }
        const x = (i % COLS) * (cellSize + borderSize) + borderSize;
        const y = Math.floor(i / COLS) * (cellSize + borderSize) + borderSize;
        ctx.fillRect(x, y, cellSize, cellSize);
      }
    }

    for (let i = 0; i < buf.length; i++) {
      const x = i % COLS_BYTES;
      const y = Math.floor(i / COLS_BYTES);

      // Horizontal lines
      if (x == 5 || x == 10) {
        buf[i] |= 0x01;
        // tick marks
        if (y > 56 && (y - 56) % 60 == 0) {
          buf[i] |= 0x03;
        }
      }

      // Vertical lines
      if (y == 56) {
        buf[i] |= 0xFF;
      }
    }

    // Font render
    const temperature = 23.42;
    const temp_min = 20.52;
    const temp_max = 28.71;
    const humidity = 56.71;
    const humi_min = 49.21;
    const humi_max = 61.31;
    const co2 = 986.6;
    const co2_min = 876.66;
    const co2_max = 1123.9;

    // Temperature
    drawNum(1, 3, false, temperature, buf);
    drawNum(4, 0, true, temp_max, buf);
    drawFont(4, 23, true, FONT_HYPHEN, buf); // hyphen
    drawNum(4, 30, true, temp_min, buf);
    // Humidity
    drawNum(6, 3, false, humidity, buf);
    drawNum(9, 0, true, humi_max, buf);
    drawFont(9, 23, true, FONT_HYPHEN, buf);
    drawNum(9, 30, true, humi_min, buf);
    // CO2
    drawNum(11, 3, false, co2, buf);
    drawNum(14, 0, true, co2_max, buf);
    drawFont(14, 23, true, FONT_HYPHEN, buf);
    drawNum(14, 30, true, co2_min, buf);

    // Tests
    for (let y = 0; y < 11; y++) {
      drawFont(1, 106 + y * FONT_H, false, y, buf);
    }
    for (let y = 0; y < 11; y++) {
      drawFont(4, 107 + y * FONT_SMALL_H, true, y, buf);
    }

    draw();
  </script>
  <style>
    body {
      width: 100%;
      margin: 0;
      display: flex;
      background-color: #f5f5f5;
    }

    canvas {
      padding: 3rem 0;
      margin: 0 auto;
      transform: rotate(90deg);
    }
  </style>
</body>

</html>
