<!DOCTYPE html>
<html lang="en">

<body>
  <canvas>
  </canvas>
  <script src="./fonts.js"></script>
  <script>
    const COLS = 128;
    const ROWS = 296;
    const cellSize = 3;
    const borderSize = 0.5;
    const devicePixelRatio = window.devicePixelRatio || 1;

    const buf = new Uint8Array(COLS * ROWS / 8);

    const canvas = document.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    const width = COLS * (cellSize + borderSize) + borderSize;
    const height = ROWS * (cellSize + borderSize) + borderSize;
    canvas.width = width * devicePixelRatio;
    canvas.height = height * devicePixelRatio;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    ctx.scale(devicePixelRatio, devicePixelRatio);

    let rotated = false;
    canvas.addEventListener('click', () => {
      rotated = !rotated;
      if (rotated) {
        canvas.style.transform = 'rotate(0deg)';
        return;
      }
      canvas.style.transform = 'rotate(90deg)';
    })

    const toIdx = (x, y) => {
      return y * 16 + x;
    }

    const drawFont = (start_x, start_y, font, isSmall, buf) => {
      let font_w = 3;
      let font_h = 14;
      if (isSmall) {
        font_w = 2;
        font_h = 7;
      }
      for (let offset_x = 0; offset_x < font_w; offset_x++) {
        for (let offset_y = 0; offset_y < font_h; offset_y++) {
          buf[toIdx(start_x + offset_x, start_y + offset_y)] |= font[offset_y * font_w + offset_x];
        }
      }
    }

    const draw = () => {
      ctx.fillStyle = '#f5f5f5';
      ctx.fillRect(0, 0, width, height);
      for (let i = 0; i < COLS * ROWS; i++) {
        const byte = buf[Math.floor(i / 8)];
        const bit = 7 - (i & 7);
        ctx.fillStyle = '#fff';
        if ((byte >> bit) & 1) {
          ctx.fillStyle = '#000';
        }
        const x = (i % COLS) * (cellSize + borderSize) + borderSize;
        const y = Math.floor(i / COLS) * (cellSize + borderSize) + borderSize;
        ctx.fillRect(x, y, cellSize, cellSize);
      }
    }

    for (let i = 0; i < buf.length; i++) {
      const x = i % 16;
      const y = Math.floor(i / 16);

      // Horizontal lines
      if (x == 5 || x == 10) {
        buf[i] |= 0x01;
        // tick marks
        if (y > 56 && (y - 56) % 60 == 0) {
          buf[i] |= 0x03;
        }
      }

      // Vertical lines
      if (y == 56) {
        buf[i] |= 0xFF;
      }
    }

    // Font render
    for (let x = 0; x < 3; x++) {
      let h_offset = 0;
      for (let y = 0; y < 4; y++) {
        let font_idx = Math.floor(Math.random() * 10);
        let font_idx_2 = 9 - font_idx;
        if (y == 1 && x != 2) {
          font_idx = 10; // dot
          font_idx_2 = 10;
          h_offset--;
        } else if (y == 2 && x != 2) {
          h_offset--;
        }
        drawFont(1 + x * 5, 3 + y * 12, fonts[font_idx], false, buf);
        drawFont(4 + x * 5, h_offset + y * 6, fonts_small[font_idx], true, buf);
        drawFont(4 + x * 5, h_offset + 30 + y * 6, fonts_small[font_idx_2], true, buf);
      }
    }

    for (let y = 0; y < 11; y++) {
      drawFont(1, 106 + y * 14, fonts[y], false, buf);
    }
    for (let y = 0; y < 11; y++) {
      drawFont(4, 107 + y * 7, fonts_small[y], true, buf);
    }

    draw();
  </script>
  <style>
    body {
      width: 100%;
      margin: 0;
      display: flex;
      background-color: #f5f5f5;
    }

    canvas {
      padding: 3rem 0;
      margin: 0 auto;
      transform: rotate(90deg);
    }
  </style>
</body>

</html>
